<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:GamerLinkApp.ViewModels"
             x:Class="GamerLinkApp.Views.OrderReviewPage"
             x:DataType="vm:OrderReviewViewModel"
             Title="&#35780;&#20215;&#35746;&#21333;"
             BackgroundColor="#F4F5F7"
             Shell.TabBarIsVisible="False">
    <Grid RowDefinitions="*,Auto">
        <ScrollView Grid.Row="0"
                    Padding="20,16"
                    IsVisible="False">
            <ScrollView.Triggers>
                <DataTrigger TargetType="ScrollView"
                             Binding="{Binding HasOrder}"
                             Value="True">
                    <Setter Property="IsVisible" Value="True" />
                </DataTrigger>
            </ScrollView.Triggers>
            <VerticalStackLayout Spacing="18">
                <Border BackgroundColor="White"
                        Padding="16"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>
                    <Grid ColumnDefinitions="Auto,*"
                          ColumnSpacing="16">
                        <Border WidthRequest="88"
                                HeightRequest="88"
                                StrokeThickness="0"
                                BackgroundColor="#EEF1F5"
                                VerticalOptions="Start">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="14" />
                            </Border.StrokeShape>
                            <Image Source="{Binding Service.ThumbnailUrl}"
                                   Aspect="AspectFill" />
                        </Border>

                        <VerticalStackLayout Grid.Column="1"
                                             Spacing="10">
                            <Label Text="{Binding ServiceName}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#1A1A1A" />
                            <Label Text="{Binding Service.GameName, StringFormat='&#25152;&#23646;&#28216;&#25103;&#65306;{0}', TargetNullValue='&#25152;&#23646;&#28216;&#25103;&#65306;-'}"
                                   FontSize="14"
                                   TextColor="#6B7280" />
                            <Label Text="{Binding Service.ServiceType, StringFormat='&#26381;&#21153;&#31867;&#22411;&#65306;{0}', TargetNullValue='&#26381;&#21153;&#31867;&#22411;&#65306;-'}"
                                   FontSize="14"
                                   TextColor="#6B7280" />
                        </VerticalStackLayout>
                    </Grid>
                </Border>

                <Border BackgroundColor="White"
                        Padding="20"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="12">
                        <Label Text="&#35746;&#21333;&#20449;&#24687;"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="#1A1A1A" />
                        <Label Text="{Binding OrderNumberDisplay}"
                               FontSize="13"
                               TextColor="#434A59" />
                        <Label Text="{Binding OrderDateDisplay, StringFormat='&#19979;&#21333;&#26102;&#38388;&#65306;{0}'}"
                               FontSize="13"
                               TextColor="#434A59" />
                        <Label Text="{Binding OrderStatusDisplay, StringFormat='&#24403;&#21069;&#29366;&#24577;&#65306;{0}'}"
                               FontSize="13"
                               TextColor="#434A59" />
                    </VerticalStackLayout>
                </Border>

                <Border BackgroundColor="White"
                        Padding="20"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="16">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="&#32508;&#21512;&#35780;&#20998;"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#1A1A1A" />
                            <Label Text="&#35831;&#36873;&#25321; 1-5 &#20998;&#30340;&#35780;&#20998;&#65292;5 &#20998;&#20195;&#34920;&#38750;&#24120;&#28385;&#24847;"
                                   FontSize="12"
                                   TextColor="#87909F" />
                        </VerticalStackLayout>

                        <HorizontalStackLayout Spacing="12"
                                               VerticalOptions="Center">
                            <HorizontalStackLayout BindableLayout.ItemsSource="{Binding RatingStars}"
                                                   Spacing="6">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="vm:OrderReviewViewModel+RatingStarItem">
                                        <Grid>
                                            <Label Text="â˜…"
                                                   FontSize="28"
                                                   TextColor="#D0D5DD">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label"
                                                                 Binding="{Binding IsFilled}"
                                                                 Value="True">
                                                        <Setter Property="TextColor" Value="#FFB400" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnRatingStarTapped"
                                                                      CommandParameter="{Binding Value}" />
                                            </Grid.GestureRecognizers>
                                        </Grid>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                            <Label Text="{Binding RatingDisplay}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#3478F6" />
                        </HorizontalStackLayout>

                        <VerticalStackLayout Spacing="4">
                            <Label Text="&#35780;&#20215;&#20869;&#23481;"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#1A1A1A" />
                            <Label Text="&#33267;&#23569;&#22635;&#20889; 5 &#20010;&#23383;&#65292;&#24110;&#21161;&#26356;&#22810;&#29609;&#23478;&#20102;&#35299;&#23454;&#38469;&#20307;&#39564;"
                                   FontSize="12"
                                   TextColor="#87909F" />
                        </VerticalStackLayout>

                        <Editor Text="{Binding Comment, Mode=TwoWay}"
                                AutoSize="TextChanges"
                                HeightRequest="150"
                                MaxLength="200"
                                Placeholder="&#35831;&#20889;&#19979;&#26412;&#27425;&#26381;&#21153;&#20307;&#39564;"
                                TextColor="#1A1A1A">
                            <Editor.Triggers>
                                <DataTrigger TargetType="Editor"
                                             Binding="{Binding IsCommentReadOnly}"
                                             Value="True">
                                    <Setter Property="IsReadOnly" Value="True" />
                                    <Setter Property="TextColor" Value="#6B7280" />
                                </DataTrigger>
                            </Editor.Triggers>
                        </Editor>
                        <Label Text="{Binding CommentLengthIndicator}"
                               FontSize="12"
                               TextColor="#9AA0B1"
                               HorizontalOptions="End" />

                        <Border BackgroundColor="#F6F7FB"
                                Padding="12"
                                IsVisible="False">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12" />
                            </Border.StrokeShape>
                            <Border.Triggers>
                                <DataTrigger TargetType="Border"
                                             Binding="{Binding IsAlreadyReviewed}"
                                             Value="True">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Label Text="&#35813;&#35746;&#21333;&#24050;&#23436;&#25104;&#35780;&#20215;&#65292;&#22914;&#38656;&#20462;&#25913;&#35831;&#32852;&#31995;&#24179;&#21488;&#23458;&#26381;"
                                   FontSize="13"
                                   TextColor="#5A6475" />
                        </Border>
                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>
        </ScrollView>

        <VerticalStackLayout Grid.Row="0"
                             Spacing="10"
                             Padding="20"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"
                             IsVisible="True">
            <VerticalStackLayout.Triggers>
                <DataTrigger TargetType="VerticalStackLayout"
                             Binding="{Binding HasOrder}"
                             Value="True">
                    <Setter Property="IsVisible" Value="False" />
                </DataTrigger>
            </VerticalStackLayout.Triggers>
            <Label Text="&#26242;&#26080;&#21487;&#35780;&#20215;&#30340;&#35746;&#21333;"
                   FontSize="20"
                   FontAttributes="Bold"
                   TextColor="#1A1A1A" />
            <Label Text="&#35831;&#36820;&#22238;&#35746;&#21333;&#20013;&#24515;&#36873;&#25321;&#19968;&#31508;&#24453;&#35780;&#20215;&#30340;&#35746;&#21333;"
                   FontSize="14"
                   TextColor="#6B7280"
                   HorizontalTextAlignment="Center" />
        </VerticalStackLayout>

        <Button Grid.Row="1"
                Text="{Binding SubmitButtonText}"
                HeightRequest="48"
                Margin="20,12"
                CornerRadius="24"
                BackgroundColor="#5B61FF"
                TextColor="White"
                FontAttributes="Bold"
                IsEnabled="{Binding CanSubmit}"
                IsVisible="{Binding HasOrder}"
                Clicked="OnSubmitClicked" />

        <ActivityIndicator Grid.RowSpan="2"
                           IsRunning="{Binding IsBusy}"
                           IsVisible="{Binding IsBusy}"
                           Color="#3478F6"
                           WidthRequest="48"
                           HeightRequest="48"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
    </Grid>
</ContentPage>
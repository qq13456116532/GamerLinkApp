<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:GamerLinkApp.ViewModels"
             x:Class="GamerLinkApp.Views.OrderReviewPage"
             x:DataType="vm:OrderReviewViewModel"
             Title="订单评价"
             BackgroundColor="#F4F5F7"
             Shell.TabBarIsVisible="False">
    <Grid RowDefinitions="*,Auto">
        <ScrollView Grid.Row="0"
                    Padding="20,16"
                    IsVisible="False">
            <ScrollView.Triggers>
                <DataTrigger TargetType="ScrollView"
                             Binding="{Binding HasOrder}"
                             Value="True">
                    <Setter Property="IsVisible" Value="True" />
                </DataTrigger>
            </ScrollView.Triggers>

            <VerticalStackLayout Spacing="18">
                <Border BackgroundColor="White"
                        Padding="16"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>

                    <Grid ColumnDefinitions="Auto,*"
                          ColumnSpacing="16">
                        <Border WidthRequest="88"
                                HeightRequest="88"
                                StrokeThickness="0"
                                BackgroundColor="#EEF1F5"
                                VerticalOptions="Start">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="14" />
                            </Border.StrokeShape>
                            <Image Source="{Binding Service.ThumbnailUrl}"
                                   Aspect="AspectFill" />
                        </Border>

                        <VerticalStackLayout Grid.Column="1"
                                             Spacing="10">
                            <Label Text="{Binding ServiceName}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="#1A1A1A" />
                            <Label FontSize="14"
                                   TextColor="#6B7280">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="所属游戏: " />
                                        <Span Text="{Binding Service.GameName, TargetNullValue='-'}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                            <Label FontSize="14"
                                   TextColor="#6B7280">
                                <Label.FormattedText>
                                    <FormattedString>
                                        <Span Text="服务类型: " />
                                        <Span Text="{Binding Service.ServiceType, TargetNullValue='-'}" />
                                    </FormattedString>
                                </Label.FormattedText>
                            </Label>
                        </VerticalStackLayout>
                    </Grid>
                </Border>

                <Border BackgroundColor="White"
                        Padding="20"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>

                    <VerticalStackLayout Spacing="12">
                        <Label Text="订单信息"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="#1A1A1A" />
                        <Label Text="{Binding OrderNumberDisplay}"
                               FontSize="13"
                               TextColor="#434A59" />
                        <Label FontSize="13"
                               TextColor="#434A59">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="下单时间: " />
                                    <Span Text="{Binding OrderDateDisplay}" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                        <Label FontSize="13"
                               TextColor="#434A59">
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="当前状态: " />
                                    <Span Text="{Binding OrderStatusDisplay}" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </VerticalStackLayout>
                </Border>

                <Border BackgroundColor="White"
                        Padding="20"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>

                    <VerticalStackLayout Spacing="16">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="综合评分"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#1A1A1A" />
                            <Label Text="请选择 1-5 星评分，5 星表示非常满意"
                                   FontSize="12"
                                   TextColor="#87909F" />
                        </VerticalStackLayout>

                        <HorizontalStackLayout Spacing="12"
                                               VerticalOptions="Center">
                            <HorizontalStackLayout BindableLayout.ItemsSource="{Binding RatingStars}"
                                                   Spacing="6">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="vm:OrderReviewViewModel+RatingStarItem">
                                        <Grid>
                                            <Label Text="★"
                                                   FontSize="28"
                                                   TextColor="#D0D5DD">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label"
                                                                 Binding="{Binding IsFilled}"
                                                                 Value="True">
                                                        <Setter Property="TextColor" Value="#FFB400" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnRatingStarTapped"
                                                                      CommandParameter="{Binding Value}" />
                                            </Grid.GestureRecognizers>
                                        </Grid>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </HorizontalStackLayout>
                            <Label Text="{Binding RatingDisplay}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#3478F6" />
                        </HorizontalStackLayout>

                        <VerticalStackLayout Spacing="4">
                            <Label Text="评价内容"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#1A1A1A" />
                            <Label Text="至少填写 5 个字，帮助更多玩家了解实际体验"
                                   FontSize="12"
                                   TextColor="#87909F" />
                        </VerticalStackLayout>

                        <Editor Text="{Binding Comment, Mode=TwoWay}"
                                AutoSize="TextChanges"
                                HeightRequest="150"
                                MaxLength="200"
                                Placeholder="写下本次体验的想法"
                                TextColor="#1A1A1A">
                            <Editor.Triggers>
                                <DataTrigger TargetType="Editor"
                                             Binding="{Binding IsCommentReadOnly}"
                                             Value="True">
                                    <Setter Property="IsReadOnly" Value="True" />
                                    <Setter Property="TextColor" Value="#6B7280" />
                                </DataTrigger>
                            </Editor.Triggers>
                        </Editor>

                        <Label Text="{Binding CommentLengthIndicator}"
                               FontSize="12"
                               TextColor="#9AA0B1"
                               HorizontalOptions="End" />

                        <Border BackgroundColor="#F6F7FB"
                                Padding="12"
                                IsVisible="False">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12" />
                            </Border.StrokeShape>
                            <Border.Triggers>
                                <DataTrigger TargetType="Border"
                                             Binding="{Binding IsAlreadyReviewed}"
                                             Value="True">
                                    <Setter Property="IsVisible" Value="True" />
                                </DataTrigger>
                            </Border.Triggers>
                            <Label Text="该订单已完成评价，如需修改请联系平台客服"
                                   FontSize="13"
                                   TextColor="#5A6475" />
                        </Border>
                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>
        </ScrollView>

        <VerticalStackLayout Grid.Row="0"
                             Spacing="10"
                             Padding="20"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"
                             IsVisible="True">
            <VerticalStackLayout.Triggers>
                <DataTrigger TargetType="VerticalStackLayout"
                             Binding="{Binding HasOrder}"
                             Value="True">
                    <Setter Property="IsVisible" Value="False" />
                </DataTrigger>
            </VerticalStackLayout.Triggers>

            <Label Text="暂无可评价的订单"
                   FontSize="20"
                   FontAttributes="Bold"
                   TextColor="#1A1A1A" />
            <Label Text="请返回订单列表选择一条待评价的订单"
                   FontSize="14"
                   TextColor="#6B7280"
                   HorizontalTextAlignment="Center" />
        </VerticalStackLayout>

        <Button Grid.Row="1"
                Text="{Binding SubmitButtonText}"
                HeightRequest="48"
                Margin="20,12"
                CornerRadius="24"
                BackgroundColor="#5B61FF"
                TextColor="White"
                FontAttributes="Bold"
                IsEnabled="{Binding CanSubmit}"
                IsVisible="{Binding HasOrder}"
                Clicked="OnSubmitClicked" />

        <ActivityIndicator Grid.RowSpan="2"
                           IsRunning="{Binding IsBusy}"
                           IsVisible="{Binding IsBusy}"
                           Color="#3478F6"
                           WidthRequest="48"
                           HeightRequest="48"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
    </Grid>
</ContentPage>

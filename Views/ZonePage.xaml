<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:GamerLinkApp.ViewModels"
             x:Class="GamerLinkApp.Views.ZonePage"
             x:DataType="vm:ZoneViewModel"
             xmlns:model="clr-namespace:GamerLinkApp.Models"
             Title="Game Zone"
             BackgroundColor="#FFFFFF">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition>
                <!-- 正确的语法：将 OnPlatform 应用于 Width 属性 -->
                <ColumnDefinition.Width>
                    <OnPlatform x:TypeArguments="GridLength">
                        <On Platform="Windows" Value="220"/>
                        <On Platform="Android, iOS" Value="140"/>
                    </OnPlatform>
                </ColumnDefinition.Width>
            </ColumnDefinition>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- 左侧分类导航 -->
        <Border Grid.Column="0"
                Padding="0,24,0,0"
                BackgroundColor="#F5F6F8"
                StrokeThickness="0">
            <CollectionView ItemsSource="{Binding Categories}"
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedCategory, Mode=TwoWay}"
                            Margin="0"
                            BackgroundColor="Transparent">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical"
                                       ItemSpacing="0"/>
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:Category">
                        <Grid ColumnDefinitions="6,*"
                              Padding="0,14"
                              BackgroundColor="Transparent">
                            <BoxView x:Name="SelectionIndicator"
                                     WidthRequest="6"
                                     BackgroundColor="Transparent"
                                     HorizontalOptions="Fill"
                                     VerticalOptions="Fill"/>
                            <Label x:Name="CategoryLabel"
                                   Grid.Column="1"
                                   Text="{Binding Name}"
                                   FontSize="16"
                                   TextColor="#5F6473"
                                   VerticalOptions="Center"
                                   Padding="18,0"
                                   LineBreakMode="TailTruncation"/>
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="SelectionStates">
                                    <VisualState Name="Normal">
                                        <VisualState.Setters>
                                            <Setter TargetName="SelectionIndicator"
                                                    Property="BoxView.BackgroundColor"
                                                    Value="Transparent"/>
                                            <Setter TargetName="CategoryLabel"
                                                    Property="Label.TextColor"
                                                    Value="#5F6473"/>
                                            <Setter TargetName="CategoryLabel"
                                                    Property="Label.FontAttributes"
                                                    Value="None"/>
                                            <Setter Property="BackgroundColor"
                                                    Value="Transparent"/>
                                        </VisualState.Setters>
                                    </VisualState>
                                    <VisualState Name="Selected">
                                        <VisualState.Setters>
                                            <Setter TargetName="SelectionIndicator"
                                                    Property="BoxView.BackgroundColor"
                                                    Value="#3478F6"/>
                                            <Setter TargetName="CategoryLabel"
                                                    Property="Label.TextColor"
                                                    Value="#3478F6"/>
                                            <Setter TargetName="CategoryLabel"
                                                    Property="Label.FontAttributes"
                                                    Value="Bold"/>
                                            <Setter Property="BackgroundColor"
                                                    Value="#EAF1FF"/>
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Border>

        <!-- 右侧内容区域 -->
        <ScrollView Grid.Column="1">
            <VerticalStackLayout Padding="32,24"
                                 Spacing="24"
                                 BackgroundColor="#FFFFFF">
                <Label Text="{Binding SelectedCategory.Name, FallbackValue='Game Zone'}"
                       FontSize="22"
                       FontAttributes="Bold"
                       TextColor="#1F1F1F"/>

                <Label Text="No services available"
                       FontSize="14"
                       TextColor="#8E94A2"
                       HorizontalOptions="Center"
                       IsVisible="False">
                    <Label.Triggers>
                        <DataTrigger TargetType="Label"
                                     Binding="{Binding HighlightedService}"
                                     Value="{x:Null}">
                            <Setter Property="IsVisible"
                                    Value="True"/>
                        </DataTrigger>
                    </Label.Triggers>
                </Label>

                <!-- 服务列表 -->
                <CollectionView ItemsSource="{Binding Services}"
                                SelectionMode="None"
                                Margin="0"
                                BackgroundColor="Transparent">
                    <CollectionView.ItemsLayout>
                        <!-- 关键改动：根据设备类型选择布局 -->
                        <OnIdiom x:TypeArguments="ItemsLayout">
                            <OnIdiom.Phone>
                                <!-- 手机上使用垂直列表布局 -->
                                <LinearItemsLayout Orientation="Vertical"
                                                   ItemSpacing="12"/>
                            </OnIdiom.Phone>
                            <OnIdiom.Tablet>
                                <!-- 平板上使用2列网格 -->
                                <GridItemsLayout Orientation="Vertical"
                                                 Span="2"
                                                 HorizontalItemSpacing="16"
                                                 VerticalItemSpacing="16"/>
                            </OnIdiom.Tablet>
                            <OnIdiom.Desktop>
                                <!-- 桌面上使用3列或更多列的网格布局 -->
                                <GridItemsLayout Orientation="Vertical"
                                                 Span="3"
                                                 HorizontalItemSpacing="16"
                                                 VerticalItemSpacing="16"/>
                            </OnIdiom.Desktop>
                        </OnIdiom>
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:Service">
                            <Border Padding="16"
                                    BackgroundColor="#FFFFFF"
                                    StrokeThickness="1"
                                    Stroke="#E5E7EB">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12"/>
                                </Border.StrokeShape>
                                <!-- 为了更好的桌面布局，我们改用VerticalStackLayout -->
                                <VerticalStackLayout Spacing="12">
                                    <Border WidthRequest="200"
                                            HeightRequest="120"
                                            StrokeThickness="0"
                                            BackgroundColor="#F2F4F8"
                                            HorizontalOptions="Center">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8"/>
                                        </Border.StrokeShape>
                                        <Image Source="{Binding ThumbnailUrl}"
                                                Aspect="AspectFill"/>
                                    </Border>

                                    <Label Text="{Binding Title}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="#1F1F1F"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2"/>

                                    <Grid ColumnDefinitions="*, Auto">
                                        <Label Grid.Column="0"
                                               Text="{Binding Price, StringFormat='{0:C0}'}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="#E53935"
                                               VerticalOptions="Center"/>
                                        <Label Grid.Column="1"
                                               Text="{Binding PurchaseCount, StringFormat='Sold {0}'}"
                                               FontSize="12"
                                               TextColor="#8E94A2"
                                               VerticalOptions="Center"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:GamerLinkApp.ViewModels"
             x:Class="GamerLinkApp.Views.AdminDashboardPage"
             x:DataType="vm:AdminDashboardViewModel"
             Title="服务管理"
             BackgroundColor="#F4F5F7"
             Shell.TabBarIsVisible="True">
    <Grid>
        <ScrollView IsVisible="{Binding HasAccess}">
            <VerticalStackLayout Padding="20,16,20,32"
                                 Spacing="18">
                <Grid ColumnDefinitions="*,Auto,Auto"
                      VerticalOptions="Center">
                    <VerticalStackLayout Spacing="4">
                        <Label Text="服务管理面板"
                               FontSize="22"
                               FontAttributes="Bold"
                               TextColor="#1A1A1A" />
                        <Label Text="快速检索、编辑服务，并掌握最新订单动态"
                               FontSize="13"
                               TextColor="#7A8196" />
                    </VerticalStackLayout>

                    <Button Grid.Column="1"
                            Text="刷新"
                            Command="{Binding RefreshCommand}"
                            HeightRequest="38"
                            Padding="16,0"
                            BackgroundColor="#3478F6"
                            TextColor="White"
                            CornerRadius="14"
                            VerticalOptions="Center" />

                    <Button Grid.Column="2"
                            Text="退出登录"
                            Command="{Binding LogoutCommand}"
                            HeightRequest="38"
                            Padding="16,0"
                            BackgroundColor="#FF4D4F"
                            TextColor="White"
                            CornerRadius="14"
                            VerticalOptions="Center"
                            Margin="12,0,0,0" />
                </Grid>

                <Border BackgroundColor="#FFFFFF"
                        Padding="16,12"
                        StrokeThickness="0">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18" />
                    </Border.StrokeShape>
                    <Entry Text="{Binding SearchText}"
                           Placeholder="按名称、分类、游戏或标签搜索服务"
                           PlaceholderColor="#A3A9B6"
                           FontSize="14"
                           ClearButtonVisibility="WhileEditing"
                           BackgroundColor="Transparent"
                           TextColor="#1A1A1A" />
                </Border>

                <FlexLayout BindableLayout.ItemsSource="{Binding SummaryMetrics}"
                            Direction="Row"
                            Wrap="Wrap"
                            JustifyContent="Start"
                            AlignItems="Start"
                            AlignContent="Start">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="vm:AdminDashboardViewModel+SummaryMetric">
                            <Border BackgroundColor="#FFFFFF"
                                    StrokeThickness="0"
                                    Padding="16"
                                    MinimumWidthRequest="150"
                                    Margin="0,0,12,12">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="20" />
                                </Border.StrokeShape>
                                <VerticalStackLayout Spacing="6">
                                    <Label Text="{Binding Title}"
                                           FontSize="14"
                                           TextColor="#7A8196" />
                                    <Label Text="{Binding Value}"
                                           FontSize="20"
                                           FontAttributes="Bold"
                                           TextColor="#1A1A1A" />
                                    <Label Text="{Binding Description}"
                                           FontSize="12"
                                           TextColor="#9AA0B1" />
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </FlexLayout>

                <Grid RowDefinitions="Auto,Auto"
                      RowSpacing="16">
                    <Border Grid.Row="0"
                            BackgroundColor="#FFFFFF"
                            StrokeThickness="0"
                            Padding="18">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20" />
                        </Border.StrokeShape>

                        <VerticalStackLayout Spacing="14">
                            <Grid ColumnDefinitions="*,Auto"
                                  VerticalOptions="Center">
                                <Label Text="服务列表"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#1A1A1A" />
                                <ActivityIndicator Grid.Column="1"
                                                   IsVisible="{Binding IsBusy}"
                                                   IsRunning="{Binding IsBusy}"
                                                   HeightRequest="20"
                                                   WidthRequest="20" />
                            </Grid>

                            <CollectionView ItemsSource="{Binding Services}"
                                            SelectionMode="Single"
                                            SelectedItem="{Binding SelectedService, Mode=TwoWay}"
                                            HeightRequest="320">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical"
                                                       ItemSpacing="12" />
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:AdminDashboardViewModel+ServiceListItem">
                                        <Border BackgroundColor="#F6F7FB"
                                                StrokeThickness="0"
                                                Padding="14"
                                                IsVisible="{Binding IsVisible}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="18" />
                                            </Border.StrokeShape>
                                            <Border.Triggers>
                                                <DataTrigger TargetType="Border"
                                                             Binding="{Binding IsFeatured}"
                                                             Value="True">
                                                    <Setter Property="BackgroundColor" Value="#E4ECFF" />
                                                </DataTrigger>
                                            </Border.Triggers>

                                            <Grid ColumnDefinitions="*,Auto"
                                                  ColumnSpacing="10">
                                                <VerticalStackLayout Spacing="6">
                                                    <Label Text="{Binding Title}"
                                                           FontSize="15"
                                                           FontAttributes="Bold"
                                                           TextColor="#1A1A1A" />
                                                    <Label Text="{Binding GameName}"
                                                           FontSize="12"
                                                           TextColor="#7A8196" />
                                                    <HorizontalStackLayout Spacing="10">
                                                        <Label Text="{Binding PriceDisplay}"
                                                               FontSize="13"
                                                               FontAttributes="Bold"
                                                               TextColor="#3478F6" />
                                                        <Label Text="{Binding Category}"
                                                               FontSize="12"
                                                               TextColor="#9AA0B1" />
                                                    </HorizontalStackLayout>
                                                </VerticalStackLayout>

                                                <Label Grid.Column="1"
                                                       Text="{Binding FeaturedBadge}"
                                                       FontSize="12"
                                                       TextColor="#FF9F0A"
                                                       VerticalTextAlignment="Center" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>

                    <Border Grid.Row="1"
                            BackgroundColor="#FFFFFF"
                            StrokeThickness="0"
                            Padding="18">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="20" />
                        </Border.StrokeShape>

                        <VerticalStackLayout Spacing="16">
                            <Label Text="服务详情编辑"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#1A1A1A" />

                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto"
                                  ColumnDefinitions="Auto,*"
                                  ColumnSpacing="12"
                                  RowSpacing="12">
                                <Label Grid.Row="0"
                                       Grid.Column="0"
                                       Text="名称"
                                       FontSize="14"
                                       TextColor="#7A8196"
                                       VerticalTextAlignment="Center" />
                                <Entry Grid.Row="0"
                                       Grid.Column="1"
                                       Text="{Binding ServiceForm.Title}"
                                       Placeholder="请输入服务名称" />

                                <Label Grid.Row="1"
                                       Grid.Column="0"
                                       Text="价格"
                                       FontSize="14"
                                       TextColor="#7A8196"
                                       VerticalTextAlignment="Center" />
                                <Entry Grid.Row="1"
                                       Grid.Column="1"
                                       Text="{Binding ServiceForm.Price}"
                                       Keyboard="Numeric"
                                       Placeholder="输入价格（元）" />

                                <Label Grid.Row="2"
                                       Grid.Column="0"
                                       Text="所属游戏"
                                       FontSize="14"
                                       TextColor="#7A8196"
                                       VerticalTextAlignment="Center" />
                                <Entry Grid.Row="2"
                                       Grid.Column="1"
                                       Text="{Binding ServiceForm.GameName}"
                                       Placeholder="如：英雄联盟" />

                                <Label Grid.Row="3"
                                       Grid.Column="0"
                                       Text="分类"
                                       FontSize="14"
                                       TextColor="#7A8196"
                                       VerticalTextAlignment="Center" />
                                <Entry Grid.Row="3"
                                       Grid.Column="1"
                                       Text="{Binding ServiceForm.Category}"
                                       Placeholder="如：陪玩 / 代练" />

                                <Label Grid.Row="4"
                                       Grid.Column="0"
                                       Text="类型"
                                       FontSize="14"
                                       TextColor="#7A8196"
                                       VerticalTextAlignment="Center" />
                                <Entry Grid.Row="4"
                                       Grid.Column="1"
                                       Text="{Binding ServiceForm.ServiceType}"
                                       Placeholder="如：双排 / 提升段位" />

                                <Label Grid.Row="5"
                                       Grid.Column="0"
                                       Text="缩略图"
                                       FontSize="14"
                                       TextColor="#7A8196"
                                       VerticalTextAlignment="Center" />
                                <VerticalStackLayout Grid.Row="5"
                                                     Grid.Column="1"
                                                     Spacing="8">
                                    <Border WidthRequest="100"
                                            HeightRequest="100"
                                            StrokeThickness="0"
                                            BackgroundColor="#EEF1F5">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="16" />
                                        </Border.StrokeShape>
                                        <Grid>
                                            <Image Source="{Binding ServiceForm.ThumbnailUrl}"
                                                   Aspect="AspectFill"
                                                   IsVisible="True">
                                                <Image.Triggers>
                                                    <DataTrigger TargetType="Image"
                                                                 Binding="{Binding ServiceForm.ThumbnailUrl}"
                                                                 Value="">
                                                        <Setter Property="IsVisible" Value="False" />
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Image"
                                                                 Binding="{Binding ServiceForm.ThumbnailUrl}"
                                                                 Value="{x:Null}">
                                                        <Setter Property="IsVisible" Value="False" />
                                                    </DataTrigger>
                                                </Image.Triggers>
                                            </Image>
                                            <Label Text="暂无缩略图"
                                                   FontSize="12"
                                                   TextColor="#9AA0B1"
                                                   HorizontalTextAlignment="Center"
                                                   VerticalTextAlignment="Center"
                                                   IsVisible="False">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label"
                                                                 Binding="{Binding ServiceForm.ThumbnailUrl}"
                                                                 Value="">
                                                        <Setter Property="IsVisible" Value="True" />
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Label"
                                                                 Binding="{Binding ServiceForm.ThumbnailUrl}"
                                                                 Value="{x:Null}">
                                                        <Setter Property="IsVisible" Value="True" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                        </Grid>
                                    </Border>

                                    <HorizontalStackLayout Spacing="10">
                                        <Button Text="上传缩略图"
                                                Command="{Binding SelectThumbnailCommand}"
                                                IsEnabled="{Binding CanSelectThumbnail}"
                                                HeightRequest="40"
                                                Padding="16,0"
                                                BackgroundColor="#3478F6"
                                                TextColor="White"
                                                CornerRadius="14" />
                                        <Label Text="{Binding ServiceForm.ThumbnailUrl}"
                                               FontSize="11"
                                               TextColor="#9AA0B1"
                                               HorizontalOptions="FillAndExpand"
                                               LineBreakMode="CharacterWrap" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Grid>

                            <Label Text="标签（用逗号分隔）"
                                   FontSize="14"
                                   TextColor="#7A8196" />
                            <Entry Text="{Binding ServiceForm.Tags}"
                                   Placeholder="示例：教学, 冲分, 双排" />

                            <Label Text="服务简介"
                                   FontSize="14"
                                   TextColor="#7A8196" />
                            <Editor Text="{Binding ServiceForm.Description}"
                                    HeightRequest="120"
                                    AutoSize="TextChanges"
                                    Placeholder="输入服务亮点、流程等描述" />

                            <Grid ColumnDefinitions="*,Auto"
                                  VerticalOptions="Center">
                                <Label Text="设为精选推荐"
                                       FontSize="14"
                                       TextColor="#1A1A1A" />
                                <Switch Grid.Column="1"
                                        IsToggled="{Binding ServiceForm.IsFeatured}" />
                            </Grid>

                            <Label Text="{Binding ServiceForm.ValidationMessage}"
                                   FontSize="12"
                                   TextColor="#FF4D4F"
                                   IsVisible="{Binding ServiceForm.HasValidationError}" />

                            <FlexLayout Direction="Row"
                                        Wrap="Wrap"
                                        JustifyContent="Start"
                                        AlignItems="Center"
                                        AlignContent="Start">
                                <Button Text="保存修改"
                                        Command="{Binding SaveCommand}"
                                        IsEnabled="{Binding CanSave}"
                                        BackgroundColor="#3478F6"
                                        TextColor="White"
                                        HeightRequest="44"
                                        WidthRequest="120"
                                        CornerRadius="16"
                                        Margin="0,0,12,12" />

                                <Button Text="恢复表单"
                                        Command="{Binding ResetCommand}"
                                        IsEnabled="{Binding CanReset}"
                                        BackgroundColor="#EEF1F5"
                                        TextColor="#4B5563"
                                        HeightRequest="44"
                                        WidthRequest="120"
                                        CornerRadius="16"
                                        Margin="0,0,12,12" />

                                <Button Text="切换精选"
                                        Command="{Binding ToggleFeaturedCommand}"
                                        IsEnabled="{Binding CanReset}"
                                        BackgroundColor="#FF9F0A"
                                        TextColor="White"
                                        HeightRequest="44"
                                        WidthRequest="120"
                                        CornerRadius="16"
                                        Margin="0,0,12,12" />
                            </FlexLayout>

                            <Label Text="{Binding StatusMessage}"
                                   FontSize="13"
                                   TextColor="#3478F6"
                                   IsVisible="{Binding HasStatusMessage}" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <Border BackgroundColor="#FFFFFF"
                        StrokeThickness="0"
                        Padding="18">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="20" />
                    </Border.StrokeShape>
                    <VerticalStackLayout Spacing="14">
                        <Label Text="最新订单一览"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="#1A1A1A" />

                        <CollectionView ItemsSource="{Binding RecentOrders}"
                                        SelectionMode="None">
                            <CollectionView.EmptyView>
                                <Label Text="当前没有订单"
                                       FontSize="13"
                                       TextColor="#9AA0B1"
                                       HorizontalTextAlignment="Center"
                                       Padding="0,12" />
                            </CollectionView.EmptyView>
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical"
                                                   ItemSpacing="10" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="vm:AdminDashboardViewModel+OrderSnapshot">
                                    <Border BackgroundColor="#F6F7FB"
                                            StrokeThickness="0"
                                            Padding="14">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="18" />
                                        </Border.StrokeShape>

                                        <Grid ColumnDefinitions="*,Auto"
                                              RowDefinitions="Auto,Auto"
                                              RowSpacing="6">
                                            <Label Text="{Binding ServiceTitle}"
                                                   FontSize="15"
                                                   FontAttributes="Bold"
                                                   TextColor="#1A1A1A" />
                                            <Label Grid.Column="1"
                                                   Text="{Binding StatusDisplay}"
                                                   FontSize="13"
                                                   TextColor="#3478F6"
                                                   HorizontalTextAlignment="End" />

                                            <Label Grid.Row="1"
                                                   Text="{Binding OrderDateDisplay}"
                                                   FontSize="12"
                                                   TextColor="#7A8196" />
                                            <Label Grid.Row="1"
                                                   Grid.Column="1"
                                                   Text="{Binding TotalPriceDisplay}"
                                                   FontSize="13"
                                                   FontAttributes="Bold"
                                                   TextColor="#1A1A1A"
                                                   HorizontalTextAlignment="End" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>
        </ScrollView>

        <Grid IsVisible="{Binding IsAccessDenied}">
            <VerticalStackLayout Padding="24"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"
                                 Spacing="14">
                <Label Text="当前账号没有管理员权限"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="#1A1A1A"
                       HorizontalTextAlignment="Center" />
                <Label Text="请使用管理员账号登录以访问服务管理功能"
                       FontSize="13"
                       TextColor="#7A8196"
                       HorizontalTextAlignment="Center" />
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
